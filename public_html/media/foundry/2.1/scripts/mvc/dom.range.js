!function(){var moduleFactory=function($){var module=this;$.require().script("mvc/dom.compare").done(function(){var exports=function(){$.fn.range=function(){return $.Range(this[0])};var convertType=function(type){return type.replace(/([a-z])([a-z]+)/gi,function(all,first,next){return first+next.toLowerCase()}).replace(/_/g,"")},reverse=function(type){return type.replace(/^([a-z]+)_TO_([a-z]+)/i,function(all,first,last){return last+"_TO_"+first})},getWindow=function(element){return element?element.ownerDocument.defaultView||element.ownerDocument.parentWindow:window
},support={};$.Range=function(range){return this.constructor!==$.Range?new $.Range(range):(range&&range.jquery&&(range=range[0]),!range||range.nodeType?(this.win=getWindow(range),this.range=this.win.document.createRange?this.win.document.createRange():this.win.document.body.createTextRange(),range&&this.select(range)):null!=range.clientX||null!=range.pageX||null!=range.left?this.moveToPoint(range):range.originalEvent&&range.originalEvent.touches&&range.originalEvent.touches.length?this.moveToPoint(range.originalEvent.touches[0]):range.originalEvent&&range.originalEvent.changedTouches&&range.originalEvent.changedTouches.length?this.moveToPoint(range.originalEvent.changedTouches[0]):this.range=range,void 0)
},$.Range.current=function(el){var selection,win=getWindow(el);return win.getSelection?(selection=win.getSelection(),new $.Range(selection.rangeCount?selection.getRangeAt(0):win.document.createRange())):new $.Range(win.document.selection.createRange())},$.extend($.Range.prototype,{moveToPoint:function(point){var clientX=point.clientX,clientY=point.clientY;if(!clientX){var off=scrollOffset();clientX=(point.pageX||point.left||0)-off.left,clientY=(point.pageY||point.top||0)-off.top}if(support.moveToPoint)return this.range=$.Range().range,this.range.moveToPoint(clientX,clientY),this;
for(var parent=document.elementFromPoint(clientX,clientY),n=0;n<parent.childNodes.length;n++){var node=parent.childNodes[n];if(3===node.nodeType||4===node.nodeType)for(var range=$.Range(node),length=range.toString().length,i=1;length+1>i;i++){var rect=range.end(i).rect();if(rect.left<=clientX&&rect.left+rect.width>=clientX&&rect.top<=clientY&&rect.top+rect.height>=clientY)return range.start(i-1),this.range=range.range,void 0}}var previous;iterate(parent.childNodes,function(textNode){var range=$.Range(textNode);
return range.rect().top>point.clientY?!1:(previous=range,void 0)}),previous?(previous.start(previous.toString().length),this.range=previous.range):this.range=$.Range(parent).range},window:function(){return this.win||window},overlaps:function(elRange){elRange.nodeType&&(elRange=$.Range(elRange).select(elRange));var startToStart=this.compare("START_TO_START",elRange),endToEnd=this.compare("END_TO_END",elRange);return 0>=startToStart&&endToEnd>=0?!0:startToStart>=0&&this.compare("START_TO_END",elRange)<=0?!0:this.compare("END_TO_START",elRange)>=0&&0>=endToEnd?!0:!1
},collapse:function(toStart){return this.range.collapse(void 0===toStart?!0:toStart),this},toString:function(){return"string"==typeof this.range.text?this.range.text:this.range.toString()},start:function(set){if(void 0===set){if(this.range.startContainer)return{container:this.range.startContainer,offset:this.range.startOffset};var start=this.clone().collapse().parent(),startRange=$.Range(start).select(start).collapse();return startRange.move("END_TO_START",this),{container:start,offset:startRange.toString().length}
}if(!this.range.setStart)throw"todo";return"number"==typeof set?this.range.setStart(this.range.startContainer,set):"string"==typeof set?this.range.setStart(this.range.startContainer,this.range.startOffset+parseInt(set,10)):this.range.setStart(set.container,set.offset),this},end:function(set){if(void 0===set){if(this.range.startContainer)return{container:this.range.endContainer,offset:this.range.endOffset};var end=this.clone().collapse(!1).parent(),endRange=$.Range(end).select(end).collapse();return endRange.move("END_TO_END",this),{container:end,offset:endRange.toString().length}
}if(!this.range.setEnd)throw"todo";return"number"==typeof set?this.range.setEnd(this.range.endContainer,set):this.range.setEnd(set.container,set.offset),this},parent:function(){if(this.range.commonAncestorContainer)return this.range.commonAncestorContainer;var parentElement=this.range.parentElement(),range=this.range;return iterate(parentElement.childNodes,function(txtNode){return $.Range(txtNode).range.inRange(range)?(parentElement=txtNode,!1):void 0}),parentElement},rect:function(from){var rect=this.range.getBoundingClientRect();
if("page"===from){var off=scrollOffset();rect=$.extend({},rect),rect.top+=off.top,rect.left+=off.left}return rect},rects:function(from){var j,rects=$.makeArray(this.range.getClientRects()).sort(function(rect1,rect2){return rect2.width*rect2.height-rect1.width*rect1.height}),i=0;for(rects.length;i<rects.length;){var cur=rects[i],found=!1;for(j=i+1,j=i+1;j<rects.length;j++)if(withinRect(cur,rects[j])){found=rects[j];break}found?rects.splice(i,1):i++}if("page"==from){var off=scrollOffset();return $.map(rects,function(item){var i=$.extend({},item);
return i.top+=off.top,i.left+=off.left,i})}return rects}}),function(){var fn=$.Range.prototype,range=$.Range().range;fn.compare=range.compareBoundaryPoints?function(type,range){return this.range.compareBoundaryPoints(this.window().Range[reverse(type)],range.range)}:function(type,range){return this.range.compareEndPoints(convertType(type),range.range)},fn.move=range.setStart?function(type,range){var rangesRange=range.range;switch(type){case"START_TO_END":this.range.setStart(rangesRange.endContainer,rangesRange.endOffset);
break;case"START_TO_START":this.range.setStart(rangesRange.startContainer,rangesRange.startOffset);break;case"END_TO_END":this.range.setEnd(rangesRange.endContainer,rangesRange.endOffset);break;case"END_TO_START":this.range.setEnd(rangesRange.startContainer,rangesRange.startOffset)}return this}:function(type,range){return this.range.setEndPoint(convertType(type),range.range),this};var cloneFunc=range.cloneRange?"cloneRange":"duplicate";range.selectNodeContents?"selectNodeContents":"moveToElementText",fn.clone=function(){return $.Range(this.range[cloneFunc]())
},fn.select=range.selectNodeContents?function(el){return el?this.range.selectNodeContents(el):this.window().getSelection().addRange(this.range),this}:function(el){if(el)if(3===el.nodeType){var end,parent=el.parentNode,start=0;iterate(parent.childNodes,function(txtNode){return txtNode===el?(end=start+txtNode.nodeValue.length,!1):(start+=txtNode.nodeValue.length,void 0)}),this.range.moveToElementText(parent),this.range.moveEnd("character",end-this.range.text.length),this.range.moveStart("character",start)}else this.range.moveToElementText(el);
else this.range.select();return this}}();var iterate=function(elems,cb){for(var elem,i=0;elems[i];i++)if(elem=elems[i],3===elem.nodeType||4===elem.nodeType){if(cb(elem)===!1)return!1}else if(8!==elem.nodeType&&iterate(elem.childNodes,cb)===!1)return!1},within=function(rect,point){return rect.left<=point.clientX&&rect.left+rect.width>=point.clientX&&rect.top<=point.clientY&&rect.top+rect.height>=point.clientY},withinRect=function(outer,inner){return within(outer,{clientX:inner.left,clientY:inner.top})&&within(outer,{clientX:inner.left+inner.width,clientY:inner.top})&&within(outer,{clientX:inner.left,clientY:inner.top+inner.height})&&within(outer,{clientX:inner.left+inner.width,clientY:inner.top+inner.height})
},scrollOffset=function(win){var win=win||window;return doc=win.document.documentElement,body=win.document.body,{left:(doc&&doc.scrollLeft||body&&body.scrollLeft||0)+(doc.clientLeft||0),top:(doc&&doc.scrollTop||body&&body.scrollTop||0)+(doc.clientTop||0)}};support.moveToPoint=!!$.Range().range.moveToPoint};exports(),module.resolveWith(exports)})};dispatch("mvc/dom.range").containing(moduleFactory).to("Foundry/2.1 Modules")}();